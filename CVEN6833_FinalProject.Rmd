### CVEN 6833 - Final Project
#### Zachary Carpenter
#### Spring 2025

This R Markdown file runs the main body of code for this final project analysis.

#####*Get Libraries*
```{r Get Libraries}
library(dplyr)
library(lubridate)
library(maps)
library(akima)
library(fields)
library(kohonen)
library(ggplot2)
library(tidyverse)
library(tibble)
library(rpart)
library(rpart.plot)


```

#####*Source Functions*
Each of these function codes can be found at the end of this document as "commented out" lines of code. The source commands here pull from the same directory/repository as this Rmd file.
```{r Source Functions}
source("CARTMod4FLow.R")

```

#####*Read and Format Flow Data*
```{r Read Flow Data}
flowdata_raw <- as.data.frame(read.csv("NatFlowDataCRB_1906_to_2020.csv", header = TRUE, skip = 3))
flowdata_raw <- flowdata_raw[1:(nrow(flowdata_raw)-5),]   # Remove summary rows

flowdata_clean <- flowdata_raw[, !sapply(flowdata_raw, anyNA)]    # Remove NA columns

flowdata_ub <- flowdata_clean[, 1:21]   # Restrict to just upper basin gages

flowdata_ub$Date <- ymd(flowdata_ub$Date)    # Converts date column to date type object

flowdata_ub_AMJ <- flowdata_ub %>% filter(month(Date) %in% 4:6)   # Filter to just spring flow (A-J)

# Convert flow data to numeric and remove commas from entries
flowdata_ub_AMJ[, 2:ncol(flowdata_ub_AMJ)] <- lapply(
  flowdata_ub_AMJ[, 2:ncol(flowdata_ub_AMJ)], 
  function(col) as.numeric(gsub(",", "", col)))


# Loop structure to sum the annual spring flow for each year and Upper Basin gage location
ann_spring_flow <- matrix(nrow = length(1906:2020), ncol = ncol(flowdata_ub_AMJ)-1) 
yrs <- as.numeric(1906:2020)

for(i in 1:length(yrs)){
  for(j in 2:ncol(flowdata_ub_AMJ)){
    ann_spring_flow[i, j - 1] = sum(flowdata_ub_AMJ[[j]][year(flowdata_ub_AMJ$Date) == yrs[i]], na.rm = TRUE)}}

ann_spring_flow <- ann_spring_flow/(10^6)   # Convert to MAF

# Add gage names and years to the annual spring flow data, convert to data frame
rownames(ann_spring_flow) <- yrs
colnames(ann_spring_flow) <- colnames(flowdata_ub_AMJ[2:ncol(flowdata_ub_AMJ)])
ann_spring_flow <- as.data.frame(ann_spring_flow)

```

#####*Cmds-4Zach.R*
This code chunk was directly provided/written by Professor R. Balaji.
```{r Cmds-4Zach.R}
nrows=72
ncols=20
ntime = 115    #Dec-Feb 1906 - Dec-Feb 2020

nyrs = ntime    #1906 - 2020

nglobe = nrows*ncols
N = nrows*ncols

### Lat - Long grid..
ygrid=seq(-22.5,72.5,by=5)
ny=length(ygrid)

xgrid=seq(27.5,382.5,by=5)
#xgrid[xgrid > 180]=xgrid[xgrid > 180]-360	#longitude on 0-360 grid if needed
nx=length(xgrid)

xygrid=matrix(0,nrow=nx*ny,ncol=2)

i=0
for(iy in 1:ny){
for(ix in 1:nx){
i=i+1
xygrid[i,1]=ygrid[iy]
xygrid[i,2]=xgrid[ix]
}}

# Read Kaplan SST data..
data=readBin("https://civil.colorado.edu/%7Ebalajir/CVEN6833/HWs/HW-2/data.r4", what="numeric", n=(nrows * ncols * ntime), size=4,endian="swap")

data <- array(data = data, dim=c( nrows, ncols, ntime ) )

data1=data[,,1]

# the lat -long data grid..
index=1:(nx*ny)

index1=index[data1 < 20 & data1 != "NaN"]	# only non-missing data.
xygrid1=xygrid[index1,]

x1=xygrid1[,2]
#x1[x1 < 0]= x1[x1 < 0] + 360
#xygrid1[,2]=x1

nsites=length(index1)
data2=data1[index1]

### SSTdata matrix - rows are seasonal (i.e. one value per year)
## and columns are locations
sstdata=matrix(NA,nrow=nyrs, ncol=nsites)

for(i in 1:nyrs){
data1=data[,,i]
index1=index[data1 < 20 & data1 != "NaN"]
data2=data1[index1]
sstdata[i,]=data2
}

sstannavg = sstdata
indexgrid = index1
rm("data")	#remove the object data to clear up space

## write out the grid locations..
write(t(xygrid1),file="kaplan-sst-locs-4Zach.txt",ncol=2)

```

#####*SOM on Winter SST*
```{r SOM on Winter SST}
# Establish the SOM Parameters
n = 4

nnodes = n^2

# Perform the SOM Computations
library(kohonen)
begin <- Sys.time()
SOM <- som(sstannavg, grid = somgrid(n,n, "rectangular"))
end <- Sys.time()
end-begin

# Plot the number of observations in each node
colors <- function(n, alpha = 1){
  rev(heat.colors(n, alpha))}

plot(SOM, type = "counts",
     palette.name = colors,
     heatkey = TRUE, main = "Number of Observations per Node")

# Write the composite data nodes
nodes = as.data.frame(array(NaN, dim = c(dim(sstannavg)[2],nnodes)))
for(i in 1:nnodes){
  index = which(SOM$unit.classif == i)
  sst_df = sstannavg[index,]
  if(length(index)>1){
    nodes[,i] = colMeans(sst_df, na.rm=T)}
  else{
    nodes[,i] = sst_df}}

noderange = range(nodes)

# Plot the SST SOM Nodes - both in a 4x4 grid and in 4, 2x2 grid plots
lon = sort(unique(xygrid[,2]))
lat = sort(unique(xygrid[,1]))

sstrange = range(nodes)

nx = 50

par(oma = c(0,0,2.5,1))
par(mfrow = c(n, n))
par(mar = c(2, 3, 2, 1))

detach(package:kohonen)

for(i in 1:nnodes){
  zfull = rep(NaN,nglobe)
  zfull[indexgrid] = nodes[,i]
  zmat = matrix(zfull, nrow = nrows, ncol = ncols)
  image.plot(lon, lat, zmat, ylim = range(-60, 90), main = paste("Node ", i, sep = ""))
  contour(lon, lat, (zmat), ylim = range(-60, 90), add = TRUE, nlev = 6, lwd = 1)
  map("world2",add=T)}

mtext("Annual Average Winter SST - SOM Maps 4x4", outer = TRUE, side = 3, cex = 1.2, line = 1)

subplots <- 4
totalplots <- nnodes
numplots <- ceiling(totalplots/subplots)

for(ploti in 1:numplots){
par(oma = c(0,0,2.5,1))
par(mfrow = c((subplots/2), (subplots/2)))
par(mar = c(2, 3, 2, 1))

start <- (ploti-1)*subplots+1
end <- min(ploti*subplots, totalplots)

for(k in start:end){
  zfull = rep(NaN,nglobe)
  zfull[indexgrid] = nodes[,k]
  zmat = matrix(zfull, nrow = nrows, ncol = ncols)
  image.plot(lon, lat, zmat, ylim = range(-60, 90), main = paste("Node ", k, sep = ""))
  contour(lon, lat, (zmat), ylim = range(-60, 90), add = TRUE, nlev = 6, lwd = 1)
  map("world2",add=T)}

  mtext(paste("Annual Average Winter SST - SOM Maps 4x4 (", ploti, " of ", numplots, ")", sep = ""),
        outer = TRUE, side = 3, cex = 1.2, line = 1)}

```

##### *Select Gages and Boxplot the Flows for Each SOM Node*
The selected gages are the Upper Colorado Reach Inflow (Colorado River @ Glenwood Springs, CO), Gunnison River @ Grand Junction, CO, Green River Below Fontenelle Reservoir, WY, Little Snake River near Lily, CO, San Juan River near Bluff, UT, and Colorado River @ Lees Ferry, AZ.    
```{r}
# Subset the annual spring flow dataset for just the selected gages
selectgage <- c(1, 6, 9, 13, 19, 20)

ann_spring_flow_sel <- ann_spring_flow[, selectgage]
colnames(ann_spring_flow_sel) <- c("CR_Glen", "Gunn_Grand", "Green_FontRes", "LSR_Lily", "SJR_Bluff", "CR_LeesFerry")

# Convert data for boxplotting with ggplot2
ann_spring_flow_sel <- ann_spring_flow_sel %>%
  rownames_to_column(var = "Year")

ann_spring_flow_sel_plot <- ann_spring_flow_sel %>%
  pivot_longer(cols = -Year, names_to = "Location", values_to = "SpringFlow")

ann_spring_flow_sel_plot$Location <- factor(
  ann_spring_flow_sel_plot$Location,
  levels = colnames(ann_spring_flow_sel)[-1])

# Boxplot the annual spring flow gage data
ggplot(ann_spring_flow_sel_plot, aes(x = Location, y = SpringFlow))+
  geom_boxplot(fill = "lightblue")+
  labs(title = "Annual Spring Flow for Select Colorado River Basin Gages (1906-2020)", x = "Location", y = "Spring Flow (MAF)")+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1))
  

```

#####*PCA on SSTs*
```{r PCA on SSTs}
# Perform the PCA
sst_pcaresult <- prcomp(sstannavg, scale. = TRUE)

# Extract the first 4 PCs
sstpcs <- as.data.frame(sst_pcaresult$x[,1:4])

```

#####*Fit and Plot a CART Model for Streamflow with the PCs*
```{r Fit a CART Model}
# Fit and plot a CART Model for each gage based on the PCs
Glen_cart <- CARTMod4Flow(ann_spring_flow_sel$CR_Glen, sstpcs, "Colorado River @ Glenwood Springs")

Gunn_cart <- CARTMod4Flow(ann_spring_flow_sel$Gunn_Grand, sstpcs, "Gunnisor River @ Grand Junction")

Green_cart <- CARTMod4Flow(ann_spring_flow_sel$Green_FontRes, sstpcs, "Green River @ Fontenelle Reservoir")

LSR_cart <- CARTMod4Flow(ann_spring_flow_sel$LSR_Lily, sstpcs, "Little Snake River @ Lily")

SJR_cart <- CARTMod4Flow(ann_spring_flow_sel$SJR_Bluff, sstpcs, "San Juan River @ Bluff")

LF_cart <- CARTMod4Flow(ann_spring_flow_sel$CR_LeesFerry, sstpcs, "Colorado River @ Lees Ferry")


```

#####*Predict Streamflow at each gage using the CART Models*
```{r Predict with CART}
# Predict streamflow at each gage with fit CART models
predvals_Glen <- predict(Glen_cart$mod, newdata = sstpcs)

predvals_Gunn <- predict(Gunn_cart$mod, newdata = sstpcs)

predvals_Green <- predict(Green_cart$mod, newdata = sstpcs)

predvals_LSR <- predict(LSR_cart$mod, newdata = sstpcs)

predvals_SJR <- predict(SJR_cart$mod, newdata = sstpcs)

predvals_LF <- predict(LF_cart$mod, newdata = sstpcs)

```

#####*Evluate the Fit of Each Model with RMSE and Correlation*
```{r Model Evaluation}


```

#####*Commented Out Functions*
```{r Functions}
### CARTMod4FLow.R
# CARTMod4Flow <- function(flowdata_gage, sst_pcs, gagename)
# {
#   cart <- rpart(flowdata_gage ~., data = sst_pcs, method = "anova")
#   
#   rpart.plot(cart, type = 3, extra = 101, under = TRUE, 
#                          tweak = 1.2, 
#                          main = paste("CART on Annual Spring Streamflow for", 
#                                       gagename, 
#                                       "\nUsing Winter SST PCs (4) as Covariates"))
#   cartplot <- recordPlot()
#   
#   return(list(
#     mod = cart,
#     plot = cartplot))
# }


### modeval.R

```






